---
title: "BUA 455 - Week 7"

subtitle: "Time Series, Data Formats, Output Formats, Project Intro"  
author: "Penelope Pooler Eisenbies"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    seal: false
    css: xaringan-themer.css
    nature:
      slideNumberFormat: "%current%/%total%" 
      highlightStyle: tomorrow-night-bright
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
      keep_md: true
---

```{r setup, include=FALSE, echo=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.retina=2,
  #out.width = "75%",
  #out.height = "50%",
  htmltools.preserve.raw = FALSE,      # needed for windows
  scipen=100,                          # suppresses scientific notation
  getSymbols.warning4.0 = FALSE,       # suppresses getSymbols warnings
  cache = FALSE,
  echo = TRUE,
  hiline = TRUE,
  message = FALSE, 
  warning = FALSE
)


# install helper package (pacman)
# pacman loads and installs other packages, if needed
if (!require("pacman")) install.packages("pacman", repos = "http://lib.stat.cmu.edu/R/CRAN/")

# install and load required packages
# pacman should be first package in parentheses and then list others
pacman::p_load(pacman, tidyverse, gridExtra, magrittr, lubridate, 
               knitr, kableExtra, tidyquant, highcharter, dygraphs, 
               htmlwidgets)

# verify packages (comment out in finished documents)
p_loaded()


```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)

palette <- c(
  SU_Orange1        = "#F76900",
  SU_Orange2        = "#FF8E00",
  SU_Red_Orange     = "#FF431B",
  SU_Blue1          = "#000E54",
  SU_Blue2          = "#203299",
  SU_Light_Blue     = "#2B72D7",
  SU_White          = "#FFFFFF",
  SU_Light_Gray     = "#ADB3B8",
  SU_Medium_Gray    = "#707780",
  SU_Black          = "#000000", 
  
  steel_blue        = "#4682B4",
  corn_flower_blue  = "#6495ED",
  deep_sky_blue     = "#00BFFF",
  dark_magenta      = "#8B008B",
  medium_orchid     = "#BA55D3",
  lime_green        = "#32CD32",
  light_sea_green   = "#20B2AA",
  chartreuse        = "#7FFF00",
  orange_red        = "#FF4500",
  white_smoke       = "#F5F5F5",
  dark_cyan         = "#008B8B",
  light_steel_blue  = "#B0C4DE",
  indigo            = "#4B0082",
  ivory             = "#FFFFF0",
  light_slate_grey  = "#778899",
  linen             = "#FAF0E6",
  steel_blue        = "#4682B4",
  blue_violet       = "#8A2BE2",
  dodger_blue       = "#1E90FF",
  light_blue        = "#ADD8E6",
  azure             = "#F0FFFF",
  lavender          = "#E6E6FA")

primary_color = "#4682B4"                # steel_blue
secondary_color = "#778899"              # light_slate_grey
white_color = "#FFFFF0"                  # ivory
black_color = "#000080"                  # navy

style_duo_accent(
  primary_color = primary_color,
  secondary_color = secondary_color,
  white_color = white_color,
  black_color = black_color,
  text_color = black_color,
  header_color = primary_color,
  background_color = white_color,
  code_inline_background_color = "#E6E6FA", # lavender
  link_color = "#1E90FF",                   # dodger_blue
  code_inline_color = "#4B0082",            # indigo
  text_bold_color = "#8B008B",              # dark_magenta
  header_font_google = google_font("Open Sans"),
  text_font_google = google_font("Open Sans"),
  code_font_google = google_font("Source Code Pro"),
  colors = palette
)


```

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

```{r xaringan-tile-view, echo=FALSE}
xaringanExtra::use_tile_view()
```

```{r xaringan-fit-screen, echo=FALSE}
xaringanExtra::use_fit_screen()
```

```{r xaringan-tachyons, echo=FALSE}
xaringanExtra::use_tachyons()
```

```{r xaringan-animate-css, echo=FALSE}
xaringanExtra::use_animate_css()
```

```{r xaringan-animate-all, echo=FALSE}
#xaringanExtra::use_animate_all("slide_up")
```

background-image: url("docs_files/images/sloth_faded.png")
background-size: cover

class: bottom, right

## BUA 455 - Week 7

### Time Series, Data Formats, Output Formats, Project Intro 

<br>


#### Penelope Pooler Eisenbies

#### `r Sys.Date()`

[Wikipedia Sloth Page](https://en.wikipedia.org/wiki/Sloth)

---

### Quiz 1 

- Quiz 1 is now graded

  - 60%: Submitted Markdown File
  
  - 40%: Blackboard Answers + Submitted .csv file + Submitted .png file

- For the most part scores were very high

  - This tells me that most of you are learning to use these skills
  
  - Please don't worry if you are not happy with your score
  
- Quiz 2 will be during Week 11 and will combine previous skills with material from weeks 6 through 10

  - Same format but more questions
  
  - More multi-step tasks

- If you have questions about your quiz, please let me know

---

### BUA 455 Group Dashboard Project

#### Groups

- Complete HW 4 - Part 1 TODAY! (This should only take 5 min.)

  - **Note:** If you do not complete this Survey, I will not put you in a project group and you can not pass this class.
  
- Groups of 6 will be determined and posted (Hopefully by Thursday)

- If you have a request to work with someone, include that information in your survey.

  - Today is your last chance to let me know.

  - I cannot guarantee that requests will be honored, but I will try.
  
<br>

#### Project Information Links

- [Project Description](https://docs.google.com/document/d/1U-DJ3yeHPpxcg1o12Cg2qc2Besb6Jw6UiyAo6gR4S2I/edit?usp=sharing)

- Project Ideas, Data Sources, etc. will be posted soon

---

### Upcoming Dates

- **October 14th-16th:** Professor Pooler is out of town
  - I will not be checking email.
  
- **Groups assigned by October 18th, but possibly sooner.**
  
- **Mon. October 24th:** Draft Proposals Due (2 - 3 paragraphs)

- **Thu. October 27th:** 
  - Groups should come with questions and be prepared to answer my questions (5 min. per groups)

-   **Mon. October 31st:**  Final Proposals Due

-   **Wed. November 2nd:**  HW 5 - Part 1 Due

-   **Thu. November 10th:**  Quiz 2 (Updated Schedule)

---

### Questions about HW 4

- Chunk Headers  
  
  - In Chunk 6 (Part 5), the chunk header in the the template appears as follows:

    ```
    {r create and save plot, eval=F}

    ```
- The `eval=F` prevents this chunk from being evaluated when it is knit.

- It was included in the template because the original code provided was incomplete and incorrect and would cause errors when knit.

- You are asked to remove the comma and the text `eval=F`

- There are many other chunk header options.

- Two common ones that you will use in your project are `echo=F` and `include=F`

- Markdown References

  - [Cheat Sheet](https://github.com/rstudio/cheatsheets/raw/main/rmarkdown-2.0.pdf)
  
  - [Reference Guide](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf)

---

### Markdown Output Formats

- So far, all work in this course has been done in R Markdown and we have intentionally used the default output format.

- Other common formats are Word documents, PDF documents, Powerpoint Slides, and **dashboards**

#### Dashboard Templates in the `flexdashboard` package

- There are many types of dashboards. Here are [some example dashboards](https://rstudio.github.io/flexdashboard/articles/examples.html) created with `flexdashboard` and other packages in R

- For this course (which focuses on Data Management), we will use a excellent introductory option, [storyboard](https://beta.rstudioconnect.com/jjallaire/htmlwidgets-showcase-storyboard/htmlwidgets-showcase-storyboard.html)
  
  - This template simplifies the dashboard development process 
  
  - Can be used to present data and visualizations in a progression

- The Storyboard template is an R Markdown file with some very **specific pre-set features**

  - **These minor details are required** or the dashboard will not knit correctly.

  - HW 5 - Part 1 and HW 5 - Part 2 will be completed in a storyboard dashboard format to give you practice working with data in this way.

---

### Types of Time Series Data in R

- In recent weeks, we have worked with Box Office Mojo and Bureau of Labor Statistics Data

- These datasets all include a date variable and another quantitative variable that changes at each time period, e.g. 

  - movie gross (HW 3)
  - unemployment rate (HW 4)
  - import and export indices (HW 4)
  
- All of these datasets are considered time series but the data format in R is called a `tibble`.

- Two common data formats in R, `tibble` and `data.frame` are needed for creating ggplots of time series.
  `tibble` are the more modern format and are more compatible with `tidyverse` commands to manage data.
  
- Today, we'll discuss a third data format, `xts` 


---

### Importing Stock Data as `xts` using `tidyquant` Package

- [Yahoo Finance](https://finance.yahoo.com/), the Federal Reserve Bank, WSJ and others are excellent data sources that can be directly imported into R
  
  - default for `getsymbols` in the `tidyquant` package is Yahoo Finance
  
  - Data format is `xts` which we will cover today
  
```{r importing data from yahoo finance, results='hide'}

# download data from Netflix, Amazon, Disney
getSymbols("NFLX", from = "2012-01-01", to = "2022-10-01")
getSymbols("AMZN", from = "2012-01-01", to = "2022-10-01")
getSymbols("DIS", from = "2012-01-01", to = "2022-10-01")

```

---

### Example of Imported Yahoo Finance Data

By default, imported datas are assigned to stock symbol in ALL CAPS, e.g. **NFLX**

```{r display of imported yahoo finance data}

head(NFLX)


```

---

### Example of `hchart` for One Stock

`hchart` in the `highcharter` package is one way to plot `xts` data

```{r hchart of 1 stock, fig.dim=c(15,5), eval=F}
hchart(NFLX$NFLX.Adjusted, name="Adjusted", color="green") |>   # plot adjusted close
  hc_add_series(NFLX$NFLX.High, name="High" , color="blue") |>  # add daily high
  hc_add_series(NFLX$NFLX.Low, name="Low" , color="red")        # add daily low

```

---

### R code for a Multi-Panel Composition of `hcharts`

- Stocks can be shown in separate plots that can be shown side by side or in one stacked column

- The command `hw_grid` is used to display them and `ncol` indicates how many columns.

```{r separate stock plots, eval=F}
nflx_plt <- hchart(NFLX$NFLX.Adjusted, name="Adjusted", color="green") |>
  hc_add_series(NFLX$NFLX.High, name="High" , color="darkgreen") |>
  hc_add_series(NFLX$NFLX.Low, name="Low" , color="lightgreen")

amzn_plt <- hchart(AMZN$AMZN.Adjusted, name="Adjusted", color="blue") |>
  hc_add_series(AMZN$AMZN.High, name="High" , color="darkblue") |>
  hc_add_series(AMZN$AMZN.Low, name="Low" , color="lightblue")

dis_plt <- hchart(DIS$DIS.Adjusted, name="Adjusted", color="mediumpurple") |>
  hc_add_series(DIS$DIS.High, name="High" , color="purple4") |>
  hc_add_series(DIS$DIS.Low, name="Low" , color="plum")
```

---

### Display of Multi-Panel Composition of `hcharts`

```{r display of plots, fig.dim=c(15,6), eval=F}
hw_grid(nflx_plt, amzn_plt, dis_plt, ncol=3)
```


---

class: middle

### Week 7 In-class Exercises (TP L11 - Q1)

***PointSolutions Session ID: bua455s22***

In the example above, we use the `hw_grid` command to create multi-plot composition of hcharts.

Previously, we covered another command to do the same thing with non-interactive ggplots of `tibble` data.

What is that other command?  

Hints: This very useful command is in the `gridExtra` package which is loaded.

If `gridExtra` is loaded, start typing `grid` in the console, and the command and others will appear.

---

class: middle

### Week 7 In-class Exercises (TP L11 - Q2)

***PointSolutions Session ID: bua455s22***

1.  Use provided exampled of `getSymbols` code to write code to import the stock time series for Apple (`AAPL`)
    -   Use these dates: from = "2012-01-01", to = "2022-08-31"
    
2.  Open the imported `xts` file by clicking on it in the `Global Environment`

3.  Sort the `AAPL.Adjusted` column by clicking on it.

4.  Answer **PL** Question:
    -   On what recent date, was AAPL at it's highest value?

---

### `XTS` Data

#### More Information about `xts` 

- When these stock datasets are imported, they are in `xts` format.

- `xts` stands for **Extensible Time Series** which means they are self-aware.

- The key feature is that `date` is NOT a variable, but instead the dates become row IDs.

  - Any dataset with a `date` variable can be converted to an `xts` dataset.

   - Any `xts` dataset can be converted a tibble or data.frame (two common R data formats).
   
```{r examine xts data}
head(NFLX)
```

---

### Merging `xts` datasets using merge

- Converting xts to a tibble or dataframe (R data formats) is required if you want to create a ggplot or use other methods covered previously

- A good first step is to create a merged xts dataset of the variables you want.

```{r merge xts stock data }
# all merged xts datasets must have same date index
nflx_amzn_dis <- merge(NFLX$NFLX.Adjusted,
                       AMZN$AMZN.Adjusted,
                       DIS$DIS.Adjusted) 
head(nflx_amzn_dis)
```

---

### Converting `xts` datasets to tibble format

- There are a few ways to convert an xts to a tibble.

- In the code below I show the conversion and then I rename the the new date variable as `date`

```{r convert xts to tibble}
# converting data to a tibble requires a couple lines of code 
# I prefer to rename the index as date 
nflx_amzn_dis_tibble <- nflx_amzn_dis |> 
  fortify.zoo() |> as_tibble(.name_repair = "minimal") |>
  rename("date" = "Index") 
head(nflx_amzn_dis_tibble)
```

---

### Converting tibble format datasets to `xts`

- Any dataset with a date formatted variable can be converted to an `xts` dataset
- We can use `hchart` or `dygraph` (next week) for any time series

```{r convert tibble to xts dataset}

exp_imp <- read_csv("export_import_tidy.csv", show_col_types=F)
exp_imp_xts <- xts(x=exp_imp[,2:3], order.by=exp_imp$date) # order.by must be a date variable

```

```{r hchart of export import data, , fig.dim=c(15,4), eval=F}
hchart(exp_imp_xts$exp_indx, name="Export Price Index", color="blue") |>
   hc_add_series(exp_imp_xts$imp_indx, name="Import Price Index" , color="red")
```

---

### Dygraphs - One Alternative to `hchart` for `XTS` data

.panelset[
.panel[.panel-name[**`dygraph` Info**]

- `dygraph` is A more flexible alternative to `hchart`.

- Both `hchart` and `dygraph` are useful and which you choose depends on your goal(s).

  - Many students find `dygraphs` useful for projects.
  - You can add reference lines and shading
  - Both `dygraph` and `hchart` allow viewer to interactively select date range
  
Here is the dataset we will use:

```{r create dataset for dygraphs}
three_stocks <- merge(AMZN$AMZN.Adjusted, DIS$DIS.Adjusted, NFLX$NFLX.Adjusted) 
names(three_stocks) <- c("AMZN.adj", "DIS.adj", "NFLX.adj")
head(three_stocks, 3) # print first three rows only
```

]

.panel[.panel-name[**Unformatted `dygraph`**]
This first plot is basic unformatted plot of three stocks with the range selector option.

```{r basic dygraph with range selector, fig.dim=c(15,4)}

(dy3 <- dygraph(three_stocks, main="Streaming Company Stock Trends") |>
  dySeries("AMZN.adj", label="AMZN", color= "green") |>
  dySeries("DIS.adj", label="DIS", color= "red") |>
  dySeries("NFLX.adj", label="NFLX", color= "blue") |>
  dyRangeSelector())

```


]

.panel[.panel-name[** Some formatting**]

Two useful formatting options (shown below) to make the plot more readable are:
 - Removing the the grid lines 
 - Formatting the axis labels
```{r dygraph with axes labeled and gridlines removed, fig.dim=c(15,3.5)}
(dy3 <- dy3 |>
  dyAxis("y", label = "Adjusted Close", drawGrid = FALSE) |>
  dyAxis("x", label = "Date", drawGrid = FALSE))
```
 

]

.panel[.panel-name[**Event Lines**]
Vertical lines can be added at specific dates and can be labeled and formatted.

```{r dygraph with event lines, fig.dim=c(15,4)}
(dy3 <- dy3 |>
  dyEvent("2020-3-12", label = "Theaters Closed", labelLoc = "bottom") |>
  dyEvent("2021-6-15", label = "Restrictions End", labelLoc = "bottom", strokePattern = "solid"))
```

]

.panel[.panel-name[**Shaded Regions**]
Alternatively, it may be helpful to shade plot for a specific time range.

```{r dygraph with shaded time period, fig.dim=c(15,4)}
(dy3 <- dy3 |>
  dyShading(from = "2020-3-12", to = "2021-6-15", axis = "x", color = "lightgrey"))
```

]

]

---
